// Prisma Schema for LLEDO Industries
// Database: PostgreSQL (Supabase/Neon recommended)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // bcrypt hashed
  firstName     String
  lastName      String
  company       String?
  phone         String?
  role          Role      @default(CLIENT)
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  applications           Application[]
  reviews                Review[]
  sessions               Session[]
  accounts               Account[]
  emailConfirmationTokens EmailConfirmationToken[]
  loginOTPs              ClientLoginOTP[]
  passwordResets         ClientPasswordReset[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Token de confirmation d'email pour les clients (inscription)
model EmailConfirmationToken {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  expires    DateTime
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_confirmation_tokens")
}

// OTP de connexion pour les clients (à chaque login)
model ClientLoginOTP {
  id        String   @id @default(cuid())
  userId    String
  code      String   // 6-digit code
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("client_login_otps")
}

// Token de réinitialisation de mot de passe pour les clients
model ClientPasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("client_password_resets")
}

enum Role {
  CLIENT
  ADMIN
}

// ============================================
// RECRUITMENT - JOBS & APPLICATIONS
// ============================================

model Job {
  id           String   @id @default(cuid())
  title        String
  slug         String   @unique
  type         String   // CDI, CDD, Stage, Alternance
  location     String
  department   String?  // MPEB, MGP, EGI, FREM
  salary       String?  // Ex: "35-45K€"
  description  String   @db.Text
  requirements String   @db.Text
  benefits     String?  @db.Text
  published    Boolean  @default(false)
  featured     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  applications Application[]

  @@map("jobs")
}

model Application {
  id        String            @id @default(cuid())
  jobId     String
  job       Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  firstName String
  lastName  String
  email     String
  phone     String?
  message   String?           @db.Text
  cvUrl     String            // URL vers le CV uploadé
  cvName    String?           // Nom original du fichier
  status    ApplicationStatus @default(NEW)
  notes     String?           @db.Text // Notes internes admin
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@map("applications")
}

enum ApplicationStatus {
  NEW
  IN_REVIEW
  INTERVIEW
  ACCEPTED
  REJECTED
}

// ============================================
// BLOG - ARTICLES
// ============================================

model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String?  @db.Text
  content     String   @db.Text
  image       String?
  tags        String[] @default([])
  published   Boolean  @default(false)
  featured    Boolean  @default(false)
  authorName  String?
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("blog_posts")
}

// ============================================
// CUSTOMER REVIEWS
// ============================================

model Review {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  authorName String?  // For manually added reviews (no user account)
  authorRole String?  // e.g. "Technicien CNC", "Responsable qualité"
  rating     Int      // 1-5
  content    String   @db.Text
  company    String?
  sector     String?  // Aéronautique, Défense, Industrie, Énergie
  approved   Boolean  @default(false)
  featured   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("reviews")
}

// ============================================
// COMPANIES (MPEB, MGP, EGI, FREM)
// ============================================

model Company {
  id             String   @id @default(cuid())
  slug           String   @unique // mpeb, mgp, egi, frem
  name           String
  tagline        String
  description    String   @db.Text
  logoUrl        String?
  heroImage      String?
  galleryImages  String[] @default([])
  capabilities   Json?    // { capacity, precision, machines }
  expertise      String[] @default([])
  certifications String[] @default([])
  stats          Json?    // [{ label, value, icon, color }]
  contactEmail   String?
  contactPhone   String?
  address        String?
  published      Boolean  @default(true)
  order          Int      @default(0) // Display order
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("companies")
}

// ============================================
// CONTACT REQUESTS (optional tracking)
// ============================================

model ContactRequest {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String
  company   String?
  phone     String?
  subject   String
  message   String   @db.Text
  status    String   @default("new") // new, read, replied
  createdAt DateTime @default(now())

  @@map("contact_requests")
}

// ============================================
// MEDIA LIBRARY (images, documents)
// ============================================

model Media {
  id          String   @id @default(cuid())
  filename    String   // Original filename
  path        String   // Storage path (e.g., /uploads/2024/01/image.jpg)
  url         String   // Public URL
  mimeType    String   // image/jpeg, image/png, application/pdf
  size        Int      // File size in bytes
  width       Int?     // Image width (if applicable)
  height      Int?     // Image height (if applicable)
  alt         String?  // Alt text for images
  caption     String?  // Optional caption
  folder      String   @default("general") // Organization folder
  uploadedBy  String?  // User ID who uploaded
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([folder])
  @@index([mimeType])
  @@map("media")
}

// ============================================
// ADMIN AUTHENTICATION - SECURE SYSTEM
// ============================================

model Admin {
  id                 String         @id @default(cuid())
  email              String         @unique
  passwordHash       String?        // bcrypt 12 rounds - null until activation
  firstName          String
  lastName           String
  company            AdminCompany
  role               AdminRole      @default(ADMIN)
  isActive           Boolean        @default(false)
  emailVerified      Boolean        @default(false)
  twoFactorEnabled   Boolean        @default(false)
  twoFactorSecret    String?        // Encrypted TOTP secret
  twoFactorMethod    TwoFactorMethod? @default(TOTP)
  backupCodes        String[]       @default([]) // Hashed backup codes
  lastLogin          DateTime?
  loginAttempts      Int            @default(0)
  lockedUntil        DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  createdBy          String?        // Admin who created this account

  // Relations
  sessions           AdminSession[]
  securityLogs       SecurityLog[]
  passwordResets     PasswordReset[]
  activationTokens   ActivationToken[]

  // Security notification preferences
  notifyNewDevice    Boolean        @default(true)
  notifyNewLocation  Boolean        @default(true)
  notifyFailedLogin  Boolean        @default(true)
  notifyPasswordChange Boolean      @default(true)
  notify2FAChange    Boolean        @default(true)

  @@map("admins")
}

enum AdminCompany {
  MPEB
  EGI
  FREM
  MGP
  Aerotools
  Groupe
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

enum TwoFactorMethod {
  TOTP      // Google Authenticator / Authy
  EMAIL     // Email OTP
  SMS       // SMS OTP (optional)
}

// ============================================
// ADMIN SESSIONS - Track active sessions
// ============================================

model AdminSession {
  id            String    @id @default(cuid())
  adminId       String
  admin         Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tokenHash     String    // Hash of JWT for verification
  refreshToken  String?   @unique // Refresh token
  ipAddress     String
  userAgent     String?
  location      String?   // City, Country via GeoIP
  device        String?   // PC, Mobile, Tablet
  browser       String?   // Chrome, Firefox, Safari
  isActive      Boolean   @default(true)
  lastActivity  DateTime  @default(now())
  createdAt     DateTime  @default(now())
  expiresAt     DateTime

  @@index([adminId])
  @@index([tokenHash])
  @@map("admin_sessions")
}

// ============================================
// SECURITY LOGS - Audit trail
// ============================================

model SecurityLog {
  id          String          @id @default(cuid())
  adminId     String?
  admin       Admin?          @relation(fields: [adminId], references: [id], onDelete: SetNull)
  eventType   SecurityEvent
  ipAddress   String?
  userAgent   String?
  location    String?
  status      SecurityStatus
  details     Json?           // Additional context
  createdAt   DateTime        @default(now())

  @@index([adminId])
  @@index([eventType])
  @@index([createdAt])
  @@map("security_logs")
}

enum SecurityEvent {
  LOGIN
  LOGOUT
  FAILED_LOGIN
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
  TWO_FACTOR_VERIFIED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  ACCOUNT_CREATED
  ACCOUNT_ACTIVATED
  SESSION_KILLED
  BACKUP_CODES_GENERATED
  SETTINGS_CHANGED
}

enum SecurityStatus {
  SUCCESS
  FAILED
  BLOCKED
  PENDING
}

// ============================================
// PASSWORD RESET TOKENS
// ============================================

model PasswordReset {
  id          String    @id @default(cuid())
  adminId     String
  admin       Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tokenHash   String    @unique // Hashed token (not stored in plain)
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([adminId])
  @@map("password_resets")
}

// ============================================
// ACTIVATION TOKENS - For new admin accounts
// ============================================

model ActivationToken {
  id          String    @id @default(cuid())
  adminId     String
  admin       Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tokenHash   String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([adminId])
  @@map("activation_tokens")
}

// ============================================
// RATE LIMITING - Store in DB for distributed systems
// ============================================

model RateLimitRecord {
  id          String    @id @default(cuid())
  key         String    // IP or user identifier
  endpoint    String    // API endpoint
  count       Int       @default(1)
  windowStart DateTime  @default(now())
  expiresAt   DateTime

  @@unique([key, endpoint])
  @@index([expiresAt])
  @@map("rate_limit_records")
}

// ============================================
// EMAIL OTP - For 2FA via email
// ============================================

// ============================================
// ANALYTICS — Page Views
// ============================================

model PageView {
  id         String   @id @default(cuid())
  path       String   // e.g. /contact, /carriere
  referrer   String?  // e.g. https://google.com
  country    String?  // e.g. FR, US
  city       String?  // e.g. Paris
  device     String?  // desktop, mobile, tablet
  browser    String?  // Chrome, Firefox, Safari
  os         String?  // Windows, macOS, Linux, iOS, Android
  sessionId  String?  // fingerprint to count unique visitors
  duration   Int?     // seconds spent on page (updated later)
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([path])
  @@index([sessionId])
  @@map("page_views")
}

model EmailOTP {
  id          String    @id @default(cuid())
  adminId     String
  code        String    // 6-digit code (hashed)
  expiresAt   DateTime
  attempts    Int       @default(0)
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([adminId])
  @@map("email_otps")
}
